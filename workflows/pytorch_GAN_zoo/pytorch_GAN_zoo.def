BootStrap: library
From: ubuntu:20.04

# Global settings
%files
    pytorch_GAN_zoo/ /

%environment
    # Add pytorch GAN zoo directory to path
    export PATH=$PATH:/pytorch_GAN_zoo

%post
    apt-get -y update

    # Add universe repository (necessary for python3-pip)
    apt-get -y install software-properties-common
    add-apt-repository -y -u universe

    # Install python packages
    apt-get -y install python3 python3-pip python3-venv

    # Make Python scripts executable
    cd /pytorch_GAN_zoo
    pwd
    ls
    for i in *.py; do sed -i "1s|^|#!/usr/bin/env python3\n|" $i; done
    chmod a+x *.py

    # Install python dependencies
    pip3 install --no-cache-dir -r requirements.txt
    pip3 install --no-cache-dir imageio  # For image processing


# CUDA 11.1 app
%apphelp cu111
    Cuda 11.1 support, torch 1.9.0, torchvision 0.10.0, torchaudio 0.9.0

%appinstall cu111
    python3 -m venv --system-site-packages ./venv_cu111
    . ./venv_cu111/bin/activate
    pip3 install --no-cache-dir torch==1.9.0+cu111 torchvision==0.10.0+cu111 torchaudio==0.9.0 -f https://download.pytorch.org/whl/torch_stable.html
    deactivate

%appenv cu111
    PATH="/scif/apps/cu111/venv_cu111/bin:$PATH"
    export PATH

# CUDA 10.2 app
%apphelp cu102
    Cuda 10.2 support, torch 1.9.0, torchvision 0.10.0, torchaudio 0.9.0

%appinstall cu102
    python3 -m venv --system-site-packages ./venv_cu102
    . ./venv_cu102/bin/activate
    pip3 install --no-cache-dir torch torchvision torchaudio
    deactivate

%appenv cu102
    PATH="/scif/apps/cu102/venv_cu102/bin:$PATH"
    export PATH


# CUDA 10.1 app
%apphelp cu101
    Cuda 10.1 support, torch 1.7.1, torchvision 0.8.2, torchaudio 0.7.2

%appinstall cu101
    python3 -m venv --system-site-packages ./venv_cu101
    . ./venv_cu101/bin/activate
    pip3 install --no-cache-dir torch==1.7.1+cu101 torchvision==0.8.2+cu101 torchaudio==0.7.2 -f https://download.pytorch.org/whl/torch_stable.html
    deactivate

%appenv cu101
    PATH="/scif/apps/cu101/venv_cu101/bin:$PATH"
    export PATH
